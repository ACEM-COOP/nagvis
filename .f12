#!/bin/bash

if [ $(uname) = Darwin ]; then
    # Short snippet for installing NagVis on OSX into MacPorts path
    # This is not meant for production use, just for development!

    BASEDIR=/opt/local/nagvis
    rsync -av etc $BASEDIR/
    sed "s|@NAGVIS_WEB@|/nagvis|g;s|@NAGVIS_PATH@|/opt/local/nagvis/share|g" $BASEDIR/etc/apache2-nagvis.conf-sample > $BASEDIR/etc/apache.conf
    if [ ! -f $BASEDIR/etc/nagvis.ini.php ]; then
        cp $BASEDIR/etc/nagvis.ini.php{-sample,}
    fi
    rsync -av share /opt/local/nagvis/
    rsync -av docs /opt/local/nagvis/share/
    mkdir -p $BASEDIR/var/tmpl/{cache,compile}
    mkdir -p $BASEDIR/etc/profiles
    chown -R _www:_www $BASEDIR/var $BASEDIR/etc $BASEDIR/share/userfiles/images/maps

    exit 0
fi

SITE=${SITE:-$(cat .site 2>/dev/null || true)}
SITE=${SITE:-$(omd sites --bare | head -n 1)}
which sudo >/dev/null 2>&1 && SUDO=sudo || SUDO=
BASE=$(pwd)

#
# Install to /usr/local/nagvis
#
$SUDO ./install.sh -a y -q -r -F -c y \
             -W /nagvis -n /usr/local/nagios \
             -i mklivestatus -p /usr/local/nagvis \
             -u www-data -g www-data \
             -w /etc/apache2/conf-available \
             -l unix:/omd/sites/muc/tmp/run/live
$SUDO rm -f /etc/apache2/conf-available/nagvis.conf.*

#
# Install to omd site local/
#
$SUDO su - $SITE -c "[ ! -d /omd/sites/$SITE/nvsrc ] && mkdir /omd/sites/$SITE/nvsrc || rm -rf /omd/sites/$SITE/nvsrc; \
cd $BASE ; \
rsync --filter='- .git' --filter='- .*.swp' -a ./ /omd/sites/$SITE/nvsrc/ ; \
cd /omd/sites/$SITE/nvsrc/ ; \
yes y | ./omd_install.sh"

exit 0
